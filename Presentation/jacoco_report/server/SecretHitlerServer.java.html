<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecretHitlerServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">1</a> &gt; <a href="index.source.html" class="el_package">server</a> &gt; <span class="el_source">SecretHitlerServer.java</span></div><h1>SecretHitlerServer.java</h1><pre class="source lang-java linenums">package server;

import game.datastructures.Identity;
import io.javalin.Javalin;
import io.javalin.http.Context;
import io.javalin.websocket.WsCloseContext;
import io.javalin.websocket.WsConnectContext;
import io.javalin.websocket.WsContext;
import io.javalin.websocket.WsMessageContext;
import org.apache.commons.lang3.StringEscapeUtils;
import org.json.JSONObject;
import server.util.Lobby;

import java.io.*;
import java.net.URI;
import java.sql.*;

import java.text.SimpleDateFormat;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

<span class="nc" id="L22">public class SecretHitlerServer {</span>

    ////// Static Fields
    // &lt;editor-fold desc=&quot;Static Fields&quot;&gt;
<span class="fc" id="L26">    private static boolean DEBUG = false;</span>
    public static final int DEFAULT_PORT_NUMBER = 4040;

    // Environmental Variable Names
    private static final String ENV_DATABASE_URL = &quot;DATABASE_URL&quot;;

    // Passed to server
    public static final String PARAM_LOBBY = &quot;lobby&quot;;
    public static final String PARAM_NAME = &quot;name&quot;;
    public static final String PARAM_COMMAND = &quot;command&quot;;
    public static final String PARAM_TARGET = &quot;target-user&quot;;
    public static final String PARAM_VOTE = &quot;vote&quot;;
    public static final String PARAM_VETO = &quot;veto&quot;;
    public static final String PARAM_CHOICE = &quot;choice&quot;; // the index of the chosen policy.
    public static final String PARAM_ICON = &quot;icon&quot;;

    // Passed to client
    // The type of the packet tells the client how to parse the contents.
    public static final String PARAM_PACKET_TYPE = &quot;type&quot;;
    public static final String PACKET_INVESTIGATION = &quot;investigation&quot;;
    public static final String PACKET_GAME_STATE = &quot;game&quot;;
    public static final String PACKET_LOBBY = &quot;lobby&quot;;
    public static final String PACKET_OK = &quot;ok&quot;; // general response packet sent after any successful command.
    public static final String PACKET_PONG = &quot;pong&quot;;  // response to pings.

    public static final String PARAM_INVESTIGATION = &quot;investigation&quot;;
    public static final String FASCIST = &quot;FASCIST&quot;;
    public static final String LIBERAL = &quot;LIBERAL&quot;;

    // These are the commands that can be passed via a websocket connection.
    public static final String COMMAND_PING = &quot;ping&quot;;
    public static final String COMMAND_START_GAME = &quot;start-game&quot;;
    public static final String COMMAND_GET_STATE = &quot;get-state&quot;;
    public static final String COMMAND_SELECT_ICON = &quot;select-icon&quot;;
    public static final String COMMAND_NOMINATE_CHANCELLOR = &quot;nominate-chancellor&quot;;
    public static final String COMMAND_REGISTER_VOTE = &quot;register-vote&quot;;
    public static final String COMMAND_REGISTER_PRESIDENT_CHOICE = &quot;register-president-choice&quot;;
    public static final String COMMAND_REGISTER_CHANCELLOR_CHOICE = &quot;register-chancellor-choice&quot;;
    public static final String COMMAND_REGISTER_CHANCELLOR_VETO = &quot;chancellor-veto&quot;;
    public static final String COMMAND_REGISTER_PRESIDENT_VETO = &quot;president-veto&quot;;

    public static final String COMMAND_REGISTER_EXECUTION = &quot;register-execution&quot;;
    public static final String COMMAND_REGISTER_SPECIAL_ELECTION = &quot;register-special-election&quot;;
    public static final String COMMAND_GET_INVESTIGATION = &quot;get-investigation&quot;;
    public static final String COMMAND_REGISTER_PEEK = &quot;register-peek&quot;;

    public static final String COMMAND_END_TERM = &quot;end-term&quot;;

    private static final String CODE_CHARACTERS = &quot;ABCDEFGHIJKLMNOPQRSTUWXYZ&quot;; // v character can look ambiguous
    private static final int CODE_LENGTH = 4;

    private static final float UPDATE_FREQUENCY_MIN = 1;
    //&lt;/editor-fold&gt;

    ///// Private Fields
    // &lt;editor-fold desc=&quot;Private Fields&quot;&gt;

<span class="fc" id="L83">    transient private static ConcurrentHashMap&lt;WsContext, Lobby&gt; userToLobby = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L84">    private static ConcurrentHashMap&lt;String, Lobby&gt; codeToLobby = new ConcurrentHashMap&lt;&gt;();</span>

    transient private static boolean hasLobbyChanged;

    // &lt;/editor-fold&gt;

    ////// Private Classes

    private static int getHerokuAssignedPort() {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (DEBUG) {</span>
<span class="nc" id="L94">            return DEFAULT_PORT_NUMBER;</span>
        }
<span class="nc" id="L96">        String herokuPort = System.getenv(&quot;PORT&quot;);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (herokuPort != null) {</span>
<span class="nc" id="L98">            return Integer.parseInt(herokuPort);</span>
        }
<span class="nc" id="L100">        return DEFAULT_PORT_NUMBER;</span>
    }

    public static void main(String[] args) {
        // On load, check the connected database to see if there's a stored state from the server.
<span class="nc" id="L105">        loadDatabaseBackup();</span>
<span class="nc" id="L106">        removeInactiveLobbies(); // immediately clean in case of redundant lobbies.</span>

        // Only initialize Javalin communication after the database has been queried.
<span class="nc" id="L109">        Javalin serverApp = Javalin.create(config -&gt; {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L111">                config.enableCorsForAllOrigins();</span>
            } else {
<span class="nc" id="L113">                config.enableCorsForOrigin(&quot;https://secret-hitler.online&quot;);</span>
            }
<span class="nc" id="L115">        }).start(getHerokuAssignedPort());</span>

<span class="nc" id="L117">        serverApp.get(&quot;/check-login&quot;, SecretHitlerServer::checkLogin); // Checks if a login is valid.</span>
<span class="nc" id="L118">        serverApp.get(&quot;/new-lobby&quot;, SecretHitlerServer::createNewLobby); // Creates and returns the code for a new lobby</span>
<span class="nc" id="L119">        serverApp.get(&quot;/ping&quot;, SecretHitlerServer::ping);</span>

<span class="nc" id="L121">        serverApp.ws(&quot;/game&quot;, wsHandler -&gt; {</span>
<span class="nc" id="L122">            wsHandler.onConnect(SecretHitlerServer::onWebsocketConnect);</span>
<span class="nc" id="L123">            wsHandler.onMessage(SecretHitlerServer::onWebSocketMessage);</span>
<span class="nc" id="L124">            wsHandler.onClose(SecretHitlerServer::onWebSocketClose);</span>
<span class="nc" id="L125">        });</span>

        // Add hook for termination that backs up the lobbies to the database.
<span class="nc" id="L128">        Runtime.getRuntime().addShutdownHook(new Thread() {</span>
            public void run() {
<span class="nc" id="L130">                System.out.println(&quot;Attempting to back up lobby data.&quot;);</span>
<span class="nc" id="L131">                storeDatabaseBackup();</span>
<span class="nc" id="L132">            }</span>
        });

        // Add timer for periodic updates.
<span class="nc" id="L136">        int delay = 0;</span>
<span class="nc" id="L137">        int period = (int) (UPDATE_FREQUENCY_MIN * 60.0f * 1000.0f);</span>
<span class="nc" id="L138">        Timer timer = new Timer();</span>
<span class="nc" id="L139">        timer.schedule(new TimerTask() {</span>
            @Override
            public void run() {
<span class="nc" id="L142">                removeInactiveLobbies();</span>
                // If there are active lobbies, store a backup of the game.
<span class="nc bnc" id="L144" title="All 4 branches missed.">                if (!codeToLobby.isEmpty() &amp;&amp; hasLobbyChanged) {</span>
<span class="nc" id="L145">                    storeDatabaseBackup();</span>
<span class="nc" id="L146">                    hasLobbyChanged = false;</span>
                }
<span class="nc" id="L148">            }</span>
        }, delay, period);
<span class="nc" id="L150">    }</span>

    /**
     * Checks for and removes any lobbies that have timed out.
     * @effects For each lobby in the {@code codeToLobby} map, checks if the lobby has timed out.
     *          If so, closes all websockets associated with the lobby and removes them from the
     *          {@code userToLobby} map, then removes the lobby from the {@code codeToLobby} map.
     */
    private static void removeInactiveLobbies() {
<span class="fc" id="L159">        Set&lt;String&gt; removedLobbyCodes = new HashSet&lt;&gt;();</span>
<span class="fc" id="L160">        int removedCount = 0;</span>
<span class="fc" id="L161">        Iterator&lt;Map.Entry&lt;String, Lobby&gt;&gt; itr = codeToLobby.entrySet().iterator();</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        while (itr.hasNext()) {</span>
<span class="fc" id="L163">            Map.Entry&lt;String, Lobby&gt; entry = itr.next();</span>
<span class="fc" id="L164">            Lobby lobby = entry.getValue();</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">            if (lobby.hasTimedOut()) {</span>
                // Remove the websocket connections.
<span class="nc bnc" id="L167" title="All 2 branches missed.">                for (WsContext ctx : lobby.getConnections()) {</span>
<span class="nc" id="L168">                    ctx.session.close(504, &quot;The lobby has timed out.&quot;);</span>
<span class="nc" id="L169">                    userToLobby.remove(ctx);</span>
<span class="nc" id="L170">                }</span>
<span class="nc" id="L171">                removedLobbyCodes.add(entry.getKey());</span>
<span class="nc" id="L172">                removedCount++;</span>
<span class="nc" id="L173">                itr.remove();</span>
            }
<span class="fc" id="L175">        }</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (removedCount &gt; 0) {</span>
<span class="nc" id="L177">            System.out.println(String.format(&quot;Removed %d inactive lobbies: %s&quot;, removedCount, removedLobbyCodes));</span>
<span class="nc" id="L178">            System.out.println(&quot;Available lobbies: &quot; + codeToLobby.keySet());</span>
<span class="nc" id="L179">            hasLobbyChanged = true;</span>
        }
<span class="fc" id="L181">    }</span>


    /////// Database Handling
    //&lt;editor-fold desc=&quot;Database Handling&quot;&gt;

    /**
     * Attempts to get a connection to the PostGres database.
     * @return null if no connection could be made.
     *         otherwise, returns a {@code java.sql.Connection} object.
     */
    private static Connection getDatabaseConnection() {
        // Get credentials from database or (if debug flag is set) via manual input.
<span class="nc" id="L194">        Connection c = null;</span>
        try {
            URI databaseUri;
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L198">                databaseUri = new URI(&quot;&quot;);</span>
            } else {
<span class="nc" id="L200">                databaseUri = new URI(System.getenv(ENV_DATABASE_URL));</span>
            }
<span class="nc" id="L202">            String username = databaseUri.getUserInfo().split(&quot;:&quot;)[0];</span>
<span class="nc" id="L203">            String password = databaseUri.getUserInfo().split(&quot;:&quot;)[1];</span>
<span class="nc" id="L204">            String dbUrl = &quot;jdbc:postgresql://&quot; + databaseUri.getHost() + ':' + databaseUri.getPort()</span>
<span class="nc" id="L205">                    + databaseUri.getPath() + &quot;?ssl=true&amp;sslmode=require&quot;;</span>

<span class="nc" id="L207">            Class.forName(&quot;org.postgresql.Driver&quot;);</span>
<span class="nc" id="L208">            c = DriverManager.getConnection(dbUrl, username, password);</span>
<span class="nc" id="L209">            System.out.println(&quot;Successfully connected to database.&quot;);</span>
<span class="nc" id="L210">            return c;</span>
<span class="nc" id="L211">        } catch (Exception e) {</span>
<span class="nc" id="L212">            System.out.println(&quot;Failed to connect to database.&quot;);</span>
<span class="nc" id="L213">            System.err.println(e);</span>
<span class="nc" id="L214">            return null;</span>
        }
    }

    /**
     * Loads lobby data stored in the database (intended to be run on server wake).
     * @effects {@code codeToLobby} is set to the stored database
     */
    private static void loadDatabaseBackup() {
        // Get connection to the Postgres Database and select the backup data.
<span class="nc" id="L224">        Connection c = getDatabaseConnection();</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (c == null) { return; }</span>
<span class="nc" id="L226">        Statement stmt = null;</span>

        try {
            // Initialize table, just in case
<span class="nc" id="L230">            initializeDatabase(c);</span>

<span class="nc" id="L232">            stmt = c.createStatement();</span>
<span class="nc" id="L233">            ResultSet rs = stmt.executeQuery(&quot;select * from backup;&quot;);</span>
<span class="nc" id="L234">            rs.next(); // Will fail if there are no entries in the table, which is fine.</span>

<span class="nc" id="L236">            String timestamp = rs.getString(&quot;timestamp&quot;);</span>
<span class="nc" id="L237">            int numAttempts = rs.getInt(&quot;attempts&quot;);</span>
<span class="nc" id="L238">            byte[] lobbyBytes = rs.getBytes(&quot;lobby_bytes&quot;);</span>
<span class="nc" id="L239">            System.out.println(&quot;Loaded backup from &quot; + timestamp + &quot;.&quot;);</span>
<span class="nc" id="L240">            rs.close();</span>
<span class="nc" id="L241">            stmt.close();</span>

            // Update the number of attempts that have been made, for debugging.
<span class="nc" id="L244">            stmt = c.createStatement();</span>
<span class="nc" id="L245">            stmt.executeUpdate(&quot;UPDATE backup SET attempts = '&quot; + (numAttempts + 1) + &quot;';&quot;);</span>
<span class="nc" id="L246">            stmt.close();</span>
<span class="nc" id="L247">            c.close();</span>

            // Deserialize the data and convert to lobbies.
<span class="nc" id="L250">            ByteArrayInputStream lobbyByteStream = new ByteArrayInputStream(lobbyBytes);</span>
            try {
<span class="nc" id="L252">                ObjectInputStream objectStream = new ObjectInputStream(lobbyByteStream);</span>
<span class="nc" id="L253">                codeToLobby = (ConcurrentHashMap&lt;String, Lobby&gt;) objectStream.readObject();</span>
<span class="nc" id="L254">                System.out.println(&quot;Successfully parsed lobby data from the database.&quot;);</span>
<span class="nc" id="L255">            } catch (Exception e) {</span>
<span class="nc" id="L256">                System.out.println(&quot;Failed to parse lobby data from stored backup. &quot;);</span>
<span class="nc" id="L257">                System.err.println( e.getClass().getName()+&quot;: &quot;+ e.getMessage() );</span>
<span class="nc" id="L258">            }</span>

<span class="nc" id="L260">        } catch (Exception e) {</span>
<span class="nc" id="L261">            System.out.println(&quot;Failed to retrieve lobby backups from the database.&quot;);</span>
<span class="nc" id="L262">            System.err.println( e.getClass().getName()+&quot;: &quot;+ e.getMessage() );</span>
<span class="nc" id="L263">        }</span>
<span class="nc" id="L264">    }</span>

    private static void storeDatabaseBackup() {
<span class="nc" id="L267">        ByteArrayOutputStream byteBuilder = new ByteArrayOutputStream();</span>
        try {
            // Serialize the Lobby data.
<span class="nc" id="L270">            ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteBuilder);</span>
<span class="nc" id="L271">            objectOutputStream.writeObject(codeToLobby);</span>
<span class="nc" id="L272">            objectOutputStream.flush();</span>
<span class="nc" id="L273">            objectOutputStream.close();</span>
<span class="nc" id="L274">            byteBuilder.flush();</span>
<span class="nc" id="L275">        } catch (Exception e) {</span>
<span class="nc" id="L276">            System.out.println(&quot;Failed to serialize the Lobby data.&quot;);</span>
<span class="nc" id="L277">            System.err.println(e);</span>
<span class="nc" id="L278">            return;</span>
<span class="nc" id="L279">        }</span>
<span class="nc" id="L280">        byte[] lobbyData = byteBuilder.toByteArray();</span>
<span class="nc" id="L281">        SimpleDateFormat formatter = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
<span class="nc" id="L282">        String timestamp =  formatter.format(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L283">        int attempts = 0;</span>

<span class="nc" id="L285">        Connection c = getDatabaseConnection();</span>
        try {
<span class="nc" id="L287">            String queryStr = &quot;INSERT INTO BACKUP (id, timestamp, attempts, lobby_bytes)&quot; +</span>
                    &quot;VALUES (0, ?, ?, ?) &quot; +
                    &quot;ON CONFLICT (id) DO UPDATE &quot; +
                    &quot;SET timestamp = excluded.timestamp, &quot; +
                    &quot;attempts = excluded.attempts, &quot; +
                    &quot;lobby_bytes = excluded.lobby_bytes; &quot;;
<span class="nc" id="L293">            PreparedStatement pstmt = c.prepareStatement(queryStr);</span>
<span class="nc" id="L294">            int i = 1;</span>
<span class="nc" id="L295">            pstmt.setString(i++, timestamp);</span>
<span class="nc" id="L296">            pstmt.setInt(i++, attempts);</span>
<span class="nc" id="L297">            pstmt.setBytes(i++, lobbyData);</span>
<span class="nc" id="L298">            pstmt.executeUpdate();</span>
<span class="nc" id="L299">            c.close();</span>
<span class="nc" id="L300">        } catch (Exception e) {</span>
<span class="nc" id="L301">            System.out.println(&quot;Failed to store the Lobby data in the database.&quot;);</span>
<span class="nc" id="L302">            System.err.println(e);</span>
<span class="nc" id="L303">            return;</span>
<span class="nc" id="L304">        }</span>
<span class="nc" id="L305">        System.out.println(&quot;Successfully saved Lobby state to the database.&quot;);</span>
<span class="nc" id="L306">    }</span>


        /**
         * Initializes the database by adding the BACKUP table.
         * @param c the connection to the database.
         * @effects the Postgres SQL datbase has a new
         */
    private static void initializeDatabase(Connection c) throws SQLException {
<span class="nc" id="L315">        Statement stmt = c.createStatement();</span>
<span class="nc" id="L316">        stmt.executeUpdate(&quot;create table if not exists backup &quot; +</span>
                &quot;(id INT UNIQUE, timestamp TEXT, attempts INT, lobby_bytes BYTEA);&quot;);
<span class="nc" id="L318">        stmt.close();</span>
<span class="nc" id="L319">    }</span>

    //&lt;/editor-fold&gt;


    /////// Get Requests
    //&lt;editor-fold desc=&quot;Get Requests&quot;&gt;

    /**
     * Pings the server (intended to wake the inactive server)
     * @param ctx the context of the login request
     * @effects Returns the message &quot;OK&quot; with status code 200.
     */
    public static void ping(Context ctx) {
<span class="fc" id="L333">        ctx.status(200);</span>
<span class="fc" id="L334">        ctx.result(&quot;OK&quot;);</span>
<span class="fc" id="L335">    }</span>

    /**
     * Determines whether a login is valid.
     * @param ctx the context of the login request.
     * @requires the context must have the following parameters:
     *          {@code lobby}: the code of the lobby.
     *          {@code name}: the username of the user.
     *          {@code command}: the command
     * @effects Result status is one of the following:
     *          &lt;p&gt;- 400: if the {@code lobby} or {@code name} parameters are missing.
     *          &lt;p&gt;- 404: if there is no lobby with the given code
     *          &lt;p&gt;- 403: the username is invalid (there is already another user with that name in the lobby.)
     *          &lt;p&gt;- 488: the lobby is currently in a game.
     *          &lt;p&gt;- 489: the lobby is full.
     *          &lt;p&gt;- 200: Success. There is a lobby with the given name and the user can open a websocket connection with
     *              these login credentials.
     */
    public static void checkLogin(Context ctx) {
<span class="fc" id="L354">        String lobbyCode = ctx.queryParam(PARAM_LOBBY);</span>
<span class="fc" id="L355">        String name = ctx.queryParam(PARAM_NAME);</span>
<span class="pc bpc" id="L356" title="2 of 4 branches missed.">        if (lobbyCode == null || name == null) {</span>
<span class="nc" id="L357">            ctx.status(400);</span>
<span class="nc" id="L358">            ctx.result(&quot;Lobby and name must be specified.&quot;);</span>
            // should return here
        }

        // or catch NullPointerException here
<span class="fc bfc" id="L363" title="All 2 branches covered.">        if (!codeToLobby.containsKey(lobbyCode)) { // lobby does not exist</span>
<span class="fc" id="L364">            ctx.status(404);</span>
<span class="fc" id="L365">            ctx.result(&quot;No such lobby found.&quot;);</span>
        } else { // the lobby exists
<span class="fc" id="L367">            Lobby lobby = codeToLobby.get(lobbyCode);</span>

<span class="pc bpc" id="L369" title="1 of 2 branches missed.">            if(lobby.isFull()) {</span>
<span class="nc" id="L370">                ctx.status(489);</span>
<span class="nc" id="L371">                ctx.result(&quot;The lobby is currently full.&quot;);</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">            } else if (lobby.isInGame()) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                if (lobby.canAddUserDuringGame(name)) {</span>
<span class="nc" id="L374">                    ctx.status(200);</span>
<span class="nc" id="L375">                    ctx.result(&quot;Login request valid (re-joining an existing game).&quot;);</span>
                } else {
<span class="nc" id="L377">                    ctx.status(488);</span>
<span class="nc" id="L378">                    ctx.result(&quot;The lobby is currently in a game.&quot;);</span>
                }
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">            } else if (lobby.hasUserWithName(name)) { // repeat username.</span>
<span class="nc" id="L381">                ctx.status(403);</span>
<span class="nc" id="L382">                ctx.result(&quot;There is already a user with the name '&quot; + name + &quot;' in the lobby.&quot;);</span>
            } else { // unique username found. Return OK.
<span class="fc" id="L384">                ctx.status(200);</span>
<span class="fc" id="L385">                ctx.result(&quot;Login request valid.&quot;);</span>
            }
        }
<span class="fc" id="L388">    }</span>

    /**
     * Generates a new lobby and returns the access code.
     * @param ctx the HTTP get request context.
     */
    public static void createNewLobby(Context ctx) {
<span class="fc" id="L395">        removeInactiveLobbies();</span>
<span class="fc" id="L396">        hasLobbyChanged = true;</span>

<span class="fc" id="L398">        String newCode = generateCode();</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">        while(codeToLobby.containsKey(newCode)) {</span>
<span class="nc" id="L400">            newCode = generateCode();</span>
        }

<span class="fc" id="L403">        Lobby lobby = new Lobby();</span>
<span class="fc" id="L404">        codeToLobby.put(newCode, lobby); // add a new lobby with the given code.</span>

<span class="fc" id="L406">        ctx.status(200);</span>
<span class="fc" id="L407">        ctx.result(newCode);</span>
<span class="fc" id="L408">        System.out.println(&quot;New lobby created: &quot; + newCode);</span>
<span class="fc" id="L409">        System.out.println(&quot;Available lobbies: &quot; + codeToLobby.keySet());</span>
<span class="fc" id="L410">    }</span>

    /**
     * Generates a random code.
     * @return a String code, with length specified by {@code this.CODE_LENGTH} and characters randomly
     *         chosen from {@code CODE_CHARACTERS}.
     */
    private static String generateCode() {
<span class="fc" id="L418">        StringBuilder builder = new StringBuilder();</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">        while (builder.length() &lt; CODE_LENGTH) {</span>
<span class="fc" id="L420">            int index = (int) (Math.random() * CODE_CHARACTERS.length());</span>
<span class="fc" id="L421">            builder.append(CODE_CHARACTERS.charAt(index));</span>
<span class="fc" id="L422">        }</span>
<span class="fc" id="L423">        return builder.toString();</span>
    }

    //&lt;/editor-fold&gt;

    /////// Websocket Handling
    //&lt;editor-fold desc=&quot;Websocket Handling&quot;&gt;

    /**
     * Called when a websocket connects to the server.
     * @param ctx the WsConnectContext of the websocket.
     * @requires the context must have the following parameters:
     *          {@code lobby}: a String representing the lobby code.
     *          {@code name}: a String username. Cannot already exist in the given lobby.
     * @effects Closes the websocket session if:
     *              400 if the {@code lobby} or {@code name} parameters are missing.
     *              404 if there is no lobby with the given code
     *              403 the username is invalid (there is already another user with that name in the lobby).
     *              488 if the lobby is currently in a game and the user is not a rejoining player.
     *              489 if the lobby is full.
     *          Otherwise, connects the user to the lobby.
     */
    private static void onWebsocketConnect(WsConnectContext ctx) {
<span class="nc bnc" id="L446" title="All 4 branches missed.">        if (ctx.queryParam(PARAM_LOBBY) == null || ctx.queryParam(PARAM_NAME) == null) {</span>
<span class="nc" id="L447">            System.out.println(&quot;A websocket request was missing a parameter and was disconnected.&quot;);</span>
<span class="nc" id="L448">            ctx.session.close(400, &quot;Must have the '&quot; + PARAM_LOBBY + &quot;' and '&quot; + PARAM_NAME + &quot;' parameters.&quot;);</span>
<span class="nc" id="L449">            return;</span>
        }

        // Sanitize user input
<span class="nc" id="L453">        String code = ctx.queryParam(PARAM_LOBBY);</span>
<span class="nc" id="L454">        String name = ctx.queryParam(PARAM_NAME);</span>
<span class="nc" id="L455">        code = StringEscapeUtils.escapeHtml4(code);</span>
<span class="nc" id="L456">        name = StringEscapeUtils.escapeHtml4(name);</span>

<span class="nc" id="L458">        System.out.print(&quot;Attempting to connect user '&quot; + name + &quot;' to lobby '&quot; + code + &quot;': &quot;);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (!codeToLobby.containsKey(code)) { // the lobby does not exist.</span>
<span class="nc" id="L460">            System.out.println(&quot;FAILED (The lobby does not exist)&quot;);</span>
<span class="nc" id="L461">            ctx.session.close(404, &quot;The lobby '&quot; + code + &quot;' does not exist.&quot;);</span>
<span class="nc" id="L462">            return;</span>
        }

<span class="nc" id="L465">        Lobby lobby = codeToLobby.get(code);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (lobby.hasUserWithName(name)) { // duplicate names not allowed</span>
<span class="nc" id="L467">            System.out.println(&quot;FAILED (Repeat username)&quot;);</span>
<span class="nc" id="L468">            ctx.session.close(403, &quot;A user with the name &quot; + name + &quot; is already in the lobby.&quot;);</span>
<span class="nc" id="L469">            return;</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        } else if (lobby.isFull()) {</span>
<span class="nc" id="L471">            System.out.println(&quot;FAILED (Lobby is full)&quot;);</span>
<span class="nc" id="L472">            ctx.session.close(489, &quot;The lobby &quot; + code + &quot; is currently full.&quot;);</span>
<span class="nc" id="L473">            return;</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">        } else if (lobby.isInGame() &amp;&amp; !lobby.canAddUserDuringGame(name)) {</span>
<span class="nc" id="L475">            System.out.println(&quot;FAILED (Lobby in game)&quot;);</span>
<span class="nc" id="L476">            ctx.session.close(488, &quot;The lobby &quot; + code + &quot; is currently in a game..&quot;);</span>
<span class="nc" id="L477">            return;</span>
        }
<span class="nc" id="L479">        System.out.println(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L480">        lobby.addUser(ctx, name);</span>
<span class="nc" id="L481">        userToLobby.put(ctx, lobby); // keep track of which lobby this connection is in.</span>
<span class="nc" id="L482">        lobby.updateAllUsers();</span>
<span class="nc" id="L483">        hasLobbyChanged = true;</span>
<span class="nc" id="L484">    }</span>


    /**
     * Parses a websocket message sent from the user.
     * @param ctx the WsMessageContext of the websocket.
     * @requires the context must have the following parameters:
     *          {@code lobby}: a String representing the lobby code.
     *          {@code name}: a String username. Cannot already exist in the given lobby.
     *          {@code command}: a String command.
     * @modifies this
     * @effects Ends the websocket command with code 400 if the specified lobby does not exist, the user is not allowed
     *          to make this action (usually because they are not a president/chancellor), if a required parameter is
     *          missing, or the command cannot be executed in this state.
     *          &lt;p&gt;
     *          Updates the game state according to the specified command and updates every other connected user
     *          with the new state.
     */
    private static void onWebSocketMessage(WsMessageContext ctx) {
        // Parse message to JSON object.
<span class="nc" id="L504">        JSONObject message = new JSONObject(ctx.message());</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (message.getString(PARAM_LOBBY) == null</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                || message.getString(PARAM_NAME) == null</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                || message.getString(PARAM_COMMAND) == null) {</span>
<span class="nc" id="L509">            System.out.println(&quot;Message request failed: missing a parameter.&quot;);</span>
<span class="nc" id="L510">            ctx.session.close(400, &quot;A required parameter is missing.&quot;);</span>
<span class="nc" id="L511">            return;</span>
        }

        // Get and sanitize inputs
<span class="nc" id="L515">        String name = message.getString(PARAM_NAME);</span>
<span class="nc" id="L516">        String lobbyCode = message.getString(PARAM_LOBBY);</span>
<span class="nc" id="L517">        lobbyCode = StringEscapeUtils.escapeHtml4(lobbyCode);</span>
<span class="nc" id="L518">        name = StringEscapeUtils.escapeHtml4(name);</span>

<span class="nc" id="L520">        String log_message = &quot;Received a message from user '&quot; + name + &quot;' in lobby '&quot; + lobbyCode + &quot;' (&quot; + ctx.message() + &quot;): &quot;;</span>
<span class="nc" id="L521">        int log_length = log_message.length();</span>
<span class="nc" id="L522">        System.out.print(log_message);</span>

<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (!codeToLobby.containsKey(lobbyCode)) {</span>
<span class="nc" id="L525">            System.out.println(&quot;FAILED (Lobby requested does not exist)&quot;);</span>
<span class="nc" id="L526">            ctx.session.close(404, &quot;The lobby does not exist.&quot;);</span>
<span class="nc" id="L527">            return;</span>
        }

<span class="nc" id="L530">        Lobby lobby = codeToLobby.get(lobbyCode);</span>

<span class="nc" id="L532">        synchronized (lobby) {</span>

<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (!lobby.hasUser(ctx, name)) {</span>
<span class="nc" id="L535">                System.out.println(&quot;FAILED (Lobby does not have the user)&quot;);</span>
<span class="nc" id="L536">                ctx.session.close(403, &quot;The user is not in the lobby &quot; + lobbyCode + &quot;.&quot;);</span>
<span class="nc" id="L537">                return;</span>
            }

<span class="nc" id="L540">            lobby.resetTimeout();</span>

<span class="nc" id="L542">            boolean updateUsers = true; // this flag can be disabled by certain commands.</span>
<span class="nc" id="L543">            boolean sendOKMessage = true;</span>
            try {
<span class="nc bnc" id="L545" title="All 16 branches missed.">                switch (message.getString(PARAM_COMMAND)) {</span>
                    case COMMAND_PING:
<span class="nc" id="L547">                        sendOKMessage = false;</span>
<span class="nc" id="L548">                        updateUsers = false;</span>
                        // Erase the previous line with spaces and \r
<span class="nc" id="L550">                        System.out.print(&quot;\r&quot; + (' ' * log_length));</span>
<span class="nc" id="L551">                        System.out.print(&quot;\r&quot;);</span>
<span class="nc" id="L552">                        JSONObject msg = new JSONObject();</span>
<span class="nc" id="L553">                        msg.put(PARAM_PACKET_TYPE, PACKET_PONG);</span>
<span class="nc" id="L554">                        ctx.send(msg.toString());</span>
<span class="nc" id="L555">                        break;</span>

                    case COMMAND_START_GAME: // Starts the game.
<span class="nc" id="L558">                        lobby.startNewGame();</span>
<span class="nc" id="L559">                        break;</span>

                    case COMMAND_GET_STATE: // Requests the updated state of the game.
<span class="nc" id="L562">                        lobby.updateUser(ctx);</span>
<span class="nc" id="L563">                        break;</span>

                    case COMMAND_NOMINATE_CHANCELLOR: // params: PARAM_TARGET (String)
<span class="nc" id="L566">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L567">                        lobby.game().nominateChancellor(message.getString(PARAM_TARGET));</span>
<span class="nc" id="L568">                        break;</span>

                    case COMMAND_REGISTER_VOTE: // params: PARAM_VOTE (boolean)
<span class="nc" id="L571">                        boolean vote = message.getBoolean(PARAM_VOTE);</span>
<span class="nc" id="L572">                        lobby.game().registerVote(name, vote);</span>
<span class="nc" id="L573">                        break;</span>

                    case COMMAND_REGISTER_PRESIDENT_CHOICE: // params: PARAM_CHOICE (int)
<span class="nc" id="L576">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L577">                        int discard = message.getInt(PARAM_CHOICE);</span>
<span class="nc" id="L578">                        lobby.game().presidentDiscardPolicy(discard);</span>
<span class="nc" id="L579">                        break;</span>

                    case COMMAND_REGISTER_CHANCELLOR_CHOICE: // params: PARAM_CHOICE (int)
<span class="nc" id="L582">                        verifyIsChancellor(name, lobby);</span>
<span class="nc" id="L583">                        int enact = message.getInt(PARAM_CHOICE);</span>
<span class="nc" id="L584">                        lobby.game().chancellorEnactPolicy(enact);</span>
<span class="nc" id="L585">                        break;</span>

                    case COMMAND_REGISTER_CHANCELLOR_VETO:
<span class="nc" id="L588">                        verifyIsChancellor(name, lobby);</span>
<span class="nc" id="L589">                        lobby.game().chancellorVeto();</span>
<span class="nc" id="L590">                        break;</span>

                    case COMMAND_REGISTER_PRESIDENT_VETO: // params: PARAM_VETO (boolean)
<span class="nc" id="L593">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L594">                        boolean veto = message.getBoolean(PARAM_VETO);</span>
<span class="nc" id="L595">                        lobby.game().presidentialVeto(veto);</span>
<span class="nc" id="L596">                        break;</span>

                    case COMMAND_REGISTER_EXECUTION: // params: PARAM_TARGET (String)
<span class="nc" id="L599">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L600">                        lobby.game().executePlayer(message.getString(PARAM_TARGET));</span>
<span class="nc" id="L601">                        break;</span>

                    case COMMAND_REGISTER_SPECIAL_ELECTION: // params: PARAM_TARGET (String)
<span class="nc" id="L604">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L605">                        lobby.game().electNextPresident(message.getString(PARAM_TARGET));</span>
<span class="nc" id="L606">                        break;</span>

                    case COMMAND_GET_INVESTIGATION: // params: PARAM_TARGET (String)
<span class="nc" id="L609">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L610">                        Identity id = lobby.game().investigatePlayer(message.getString(PARAM_TARGET));</span>
                        // Construct and send a JSONObject.
<span class="nc" id="L612">                        JSONObject obj = new JSONObject();</span>
<span class="nc" id="L613">                        obj.put(PARAM_PACKET_TYPE, PACKET_INVESTIGATION);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                        if (id == Identity.FASCIST) {</span>
<span class="nc" id="L615">                            obj.put(PARAM_INVESTIGATION, FASCIST);</span>
                        } else {
<span class="nc" id="L617">                            obj.put(PARAM_INVESTIGATION, LIBERAL);</span>
                        }
<span class="nc" id="L619">                        ctx.send(obj.toString());</span>
<span class="nc" id="L620">                        break;</span>

                    case COMMAND_REGISTER_PEEK:
<span class="nc" id="L623">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L624">                        lobby.game().endPeek();</span>
<span class="nc" id="L625">                        break;</span>

                    case COMMAND_END_TERM:
<span class="nc" id="L628">                        verifyIsPresident(name, lobby);</span>
<span class="nc" id="L629">                        lobby.game().endPresidentialTerm();</span>
<span class="nc" id="L630">                        break;</span>

                    case COMMAND_SELECT_ICON:
<span class="nc" id="L633">                        String iconId = message.getString(PARAM_ICON);</span>
<span class="nc" id="L634">                        lobby.trySetUserIcon(iconId, ctx);</span>
<span class="nc" id="L635">                        break;</span>

                    default: //This is an invalid command.
<span class="nc" id="L638">                        throw new RuntimeException(&quot;FAILED (unrecognized command &quot; + message.get(PARAM_COMMAND) + &quot;)&quot;);</span>
                }  // End switch

<span class="nc bnc" id="L641" title="All 2 branches missed.">                if (sendOKMessage) {</span>
<span class="nc" id="L642">                    System.out.println(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L643">                    JSONObject msg = new JSONObject();</span>
<span class="nc" id="L644">                    msg.put(PARAM_PACKET_TYPE, PACKET_OK);</span>
<span class="nc" id="L645">                    ctx.send(msg.toString());</span>
                }

<span class="nc" id="L648">            } catch (NullPointerException e) {</span>
<span class="nc" id="L649">                System.out.println(&quot;FAILED (&quot; + e.toString() + &quot;)&quot;);</span>
<span class="nc" id="L650">                ctx.session.close(400, &quot;NullPointerException:&quot; + e.toString());</span>
<span class="nc" id="L651">            } catch (RuntimeException e) {</span>
<span class="nc" id="L652">                System.out.println(&quot;FAILED (&quot; + e.toString() + &quot;)&quot;);</span>
<span class="nc" id="L653">                ctx.session.close(400, &quot;RuntimeException:&quot; + e.toString());</span>
<span class="nc" id="L654">            }</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (updateUsers) {</span>
<span class="nc" id="L656">                lobby.updateAllUsers();</span>
            }
<span class="nc" id="L658">        }</span>
<span class="nc" id="L659">        hasLobbyChanged = true;</span>
<span class="nc" id="L660">    }</span>

    /**
     * Verifies that the user is the president.
     * @param name String name of the user.
     * @param lobby the Lobby that the game is in.
     * @throws RuntimeException if the user is not the president.
     */
    private static void verifyIsPresident(String name, Lobby lobby) {
<span class="nc bnc" id="L669" title="All 2 branches missed.">        if (!lobby.game().getCurrentPresident().equals(name)) {</span>
<span class="nc" id="L670">            throw new RuntimeException(&quot;The player '&quot; + name + &quot;' is not currently president.&quot;);</span>
        }
<span class="nc" id="L672">    }</span>

    /**
     * Verifies that the user is the chancellor.
     * @param name String name of the user.
     * @param lobby the Lobby that the game is in.
     * @throws RuntimeException if the user is not the chancellor.
     */
    private static void verifyIsChancellor(String name, Lobby lobby) {
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (!lobby.game().getCurrentChancellor().equals(name)) {</span>
<span class="nc" id="L682">            throw new RuntimeException(&quot;The player '&quot; + name + &quot;' is not currently chancellor.&quot;);</span>
        }
<span class="nc" id="L684">    }</span>

    /**
     * Called when a websocket is closed.
     * @param ctx the WsContext of the websocket.
     * @modifies this
     * @effects Removes the user from any connected lobbies.
     */
    private static void onWebSocketClose(WsCloseContext ctx) {
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (userToLobby.containsKey(ctx)) {</span>
<span class="nc" id="L694">            Lobby lobby = userToLobby.get(ctx);</span>
<span class="nc" id="L695">            synchronized (lobby) {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                if (lobby.hasUser(ctx)) {</span>
<span class="nc" id="L697">                    lobby.removeUser(ctx);</span>
<span class="nc" id="L698">                    lobby.updateAllUsers();</span>
                }
<span class="nc" id="L700">            }</span>
<span class="nc" id="L701">            userToLobby.remove(ctx);</span>
        }
<span class="nc" id="L703">    }</span>

    //&lt;/editor-fold&gt;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>